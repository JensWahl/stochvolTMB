---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# stochvolTMB

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0)
[![R build status](https://github.com/JensWahl/stochvolTMB/workflows/R-CMD-check/badge.svg)](https://github.com/JensWahl/stochvolTMB/actions)
<!-- badges: end -->

`stochvolTMB` is a package for fitting stochastic volatility (SV) models to time series data. It is inspired by the package [stochvol](https://github.com/gregorkastner/stochvol), but parameter estimates are obtained through optimization and not MCMC, leading to significant speed up. It is built on [Template Model Builder](https://github.com/kaskr/adcomp) for fast and efficient estimation. The latent volatility is integrated out of the likelihood using the Laplace approximation and automatic differentiation (AD) is used for accurate evaluation of derivatives. 

Four distributions for the observational error are implemented: 

* **Gaussian** - The classic SV model with Gaussian noise 
* **t** - t-distributed noise for heavy tail returns 
* **Leverage** -  Extending the **Gaussian** model by allowing observed returns to be correlated with the latent volatility
* **Skew-Gaussian** - Skew-Gaussian distributed noise for asymmetric returns


## Installation

You can install `stochvolTMB` from github by running 

``` {r eval = FALSE}
# install.packages("devtools")
devtools::install_github("JensWahl/stochvolTMB")
```


## Example

The main function for estimating parameters is `estimate_parameters`:

```{r example}
library(stochvolTMB, warn.conflicts = FALSE)

# load s&p500 data from 2005 to 2018
data(spy)

# find the best model using AIC 
AIC(estimate_parameters(spy$log_return, model = "gaussian", silent = TRUE),
    estimate_parameters(spy$log_return, model = "t", silent = TRUE),
    estimate_parameters(spy$log_return, model = "skew_gaussian", silent = TRUE),
    estimate_parameters(spy$log_return, model = "leverage", silent = TRUE))

# The leverage model stand out with an AIC for below the other models
opt <- estimate_parameters(spy$log_return, model = "leverage", silent = TRUE)

# get parameter estimates with standard error
estimates <- summary(opt)
head(estimates, 10)

## plot estimated volatility with 95 % confidence interval
plot(opt, include_ci = TRUE)
```

## Comparison 

An comparison of `stochvol` and `stochvolTMB` shows about a 20 times speed up for the Gaussian model and 200 for the leverage model: 

```{r}
library(stochvol)
library(stochvolTMB)
library(microbenchmark)
library(ggplot2)

data(spy)

gaussian <- microbenchmark(
  stochvol_gauss = {svsample(spy$log_return, quiet = T)},
  stochvolTMB_gauss  = {estimate_parameters(spy$log_return, "gaussian", silent = TRUE)},
  times = 3L
)

leverage <- microbenchmark(
    stochvol_lev = {svlsample(spy$log_return, quiet = T)},
    stochvolTMB_lev  = {estimate_parameters(spy$log_return, "leverage", silent = TRUE)},
    times = 3L
)

gaussian
autoplot(gaussian, log = FALSE) + stat_summary(fun = median, geom = 'point', size = 2) + ggtitle("Comparison of stochvolTMB and stochvol for Gaussian model")
leverage
autoplot(leverage, log = FALSE) + stat_summary(fun = median, geom = 'point', size = 2) + ggtitle("Comparison of stochvolTMB and stochvol for leverage model")

```

## Shiny app 

By running `demo()` you start a shiny application where you can visually inspect the effect of choosing different models and parameter configurations 

```{r eval = FALSE}
demo()
```

![](man/figures/shinyApp.png)
